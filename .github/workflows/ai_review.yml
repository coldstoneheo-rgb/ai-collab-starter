name: AI Multi-Agent PR Review
on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  index:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "‚ö†Ô∏è requirements.txt not found, skipping..."
      - name: Build RAG index
        run: python ai/context7/indexer.py || echo "‚ö†Ô∏è Indexing skipped"

  router:
    needs: index
    runs-on: ubuntu-latest
    outputs:
      mode: ${{ steps.decide.outputs.mode }}
      enabled_agents: ${{ steps.decide.outputs.enabled_agents }}
      autofix_allowed: ${{ steps.decide.outputs.autofix_allowed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml python-dateutil || echo "Installing minimal deps..."
      - name: Run router decision
        id: decide
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üîç Running router decision..."
          python - <<'PY'
          import json
          import os
          import sys

          # Add workspace to path
          sys.path.insert(0, os.getcwd())

          from ai.router import decide_mode

          # Run decision
          decision = decide_mode('.')

          # Log decision
          print(f"‚úÖ Mode decided: {decision.mode}")
          print(f"‚úÖ Enabled agents: {decision.enabled_agents}")
          print(f"‚úÖ Autofix allowed: {decision.autofix_allowed}")
          print(f"‚úÖ Reason: {decision.reason}")

          # Write outputs
          output_path = os.environ["GITHUB_OUTPUT"]
          with open(output_path, "a", encoding="utf-8") as handle:
              handle.write(f"mode={decision.mode}\n")
              handle.write(f"enabled_agents={json.dumps(decision.enabled_agents)}\n")
              handle.write(f"autofix_allowed={'true' if decision.autofix_allowed else 'false'}\n")
          PY

  claude_review:
    needs: router
    if: contains(fromJson(needs.router.outputs.enabled_agents), 'claude')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml python-dateutil || true
      - name: Run Claude Review
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "ü§ñ Running Claude PM Review (mode: ${{ needs.router.outputs.mode }})"
          python ai/runners/run_claude_review.py --pr-number ${{ github.event.pull_request.number }} || echo "‚ö†Ô∏è Claude review failed (runner is stub)"
      - name: Comment result
        if: always()
        run: echo "‚úÖ Claude review job completed"

  gemini_review:
    needs: [router, claude_review]
    if: contains(fromJson(needs.router.outputs.enabled_agents), 'gemini')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml python-dateutil || true
      - name: Run Gemini Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üé® Running Gemini UI/UX Review (mode: ${{ needs.router.outputs.mode }})"
          python ai/runners/run_gemini_review.py || echo "‚ö†Ô∏è Gemini review failed (runner is stub)"
      - name: Comment result
        if: always()
        run: echo "‚úÖ Gemini review job completed"

  perplexity_review:
    needs: [router, claude_review, gemini_review]
    if: contains(fromJson(needs.router.outputs.enabled_agents), 'perplexity')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml python-dateutil || true
      - name: Run Perplexity Review
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "‚öñÔ∏è Running Perplexity Compliance Review (mode: ${{ needs.router.outputs.mode }})"
          python ai/runners/run_perplexity_review.py || echo "‚ö†Ô∏è Perplexity review failed (runner is stub)"
      - name: Comment result
        if: always()
        run: echo "‚úÖ Perplexity review job completed"
